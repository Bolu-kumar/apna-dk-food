<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Export Firebase Data to CSV</title>
    <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.0/firebase-database.js"></script>
</head>

<body>
    <label for="startDate">Start Date:</label>
    <input type="date" id="startDate">
    <label for="endDate">End Date:</label>
    <input type="date" id="endDate">
    <button id="exportButton">Export Data to CSV</button>

    <!-- Template Stylesheet -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBLvhQ5Ag0kDvqCVN1ggKmx1ZgBPk_XfYI",
            authDomain: "diwakar-tiffin-services.firebaseapp.com",
            databaseURL: "https://diwakar-tiffin-services-default-rtdb.firebaseio.com",
            projectId: "diwakar-tiffin-services",
            storageBucket: "diwakar-tiffin-services.appspot.com",
            messagingSenderId: "901872908984",
            appId: "1:901872908984:web:5eb4319972dbb49b4e524d"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);



        // Function to export data to CSV
        async function exportToCsv(filename, headers, rows) {
            try {
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: filename,
                    types: [{
                        description: 'CSV Files',
                        accept: {
                            'text/csv': ['.csv'],
                        },
                    }],
                });
                const writableStream = await fileHandle.createWritable();

                // Write headers to the CSV file
                await writableStream.write(headers.join(',') + '\n');

                // Write data rows to the CSV file
                for (const row of rows) {
                    await writableStream.write(row.join(',') + '\n');
                }

                await writableStream.close();
            } catch (err) {
                console.error('Error saving file:', err);
            }
        }

        // Fetch data from Firebase and convert to CSV
        document.getElementById("exportButton").addEventListener("click", async function () {
            firebase.database().ref('foodOrder').once('value', function (snapshot) {
                var data = snapshot.val();
                var rows = [];

                // Define headers corresponding to each column
                var headers = [
                    "orderId", "timestamp", "name", "phoneNumber", "email",
                    "selectedMeal", "totalAmount", "mealFields", "address",
                    "deliveryMethod", "status"
                ];

                // Convert Firebase data to CSV format
                for (var key in data) {
                    if (data.hasOwnProperty(key)) {
                        var row = [];
                        // Push data for each field into the row array
                        row.push(`"${data[key].orderId || ''}"`);
                        row.push(`"${data[key].timestamp || ''}"`);
                        row.push(`"${data[key].name || ''}"`);
                        row.push(`"${data[key].phoneNumber || ''}"`);
                        row.push(`"${data[key].email || ''}"`);
                        row.push(`"${data[key].selectedMeal || ''}"`);
                        row.push(`"${data[key].totalAmount || ''}"`);
                        var mealFields = data[key].mealFields ? `"${data[key].mealFields.join(', ')}"` : '';
                        row.push(mealFields);
                        row.push(`"${data[key].address || ''}"`);
                        row.push(`"${data[key].deliveryMethod || ''}"`);
                        row.push(`"${data[key].status || ''}"`);

                        rows.push(row);
                    }
                }

                // Export data to CSV with headers
                exportToCsv('firebase_data.csv', headers, rows);
            });
        });


    </script>
</body>

</html>